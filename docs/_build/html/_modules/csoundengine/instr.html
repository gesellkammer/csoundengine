

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>csoundengine.instr &mdash; csoundengine  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> csoundengine
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Reference.html">Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">csoundengine</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>csoundengine.instr</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for csoundengine.instr</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">emlib</span> <span class="kn">import</span> <span class="n">textlib</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="kn">import</span> <span class="n">CsoundError</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">csoundlib</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span> <span class="k">as</span> <span class="n">Opt</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span> <span class="k">as</span> <span class="n">U</span><span class="p">,</span> <span class="n">Sequence</span> <span class="k">as</span> <span class="n">Seq</span><span class="p">,</span> <span class="n">Tuple</span>


<div class="viewcode-block" id="Instr"><a class="viewcode-back" href="../../api/csoundengine.Instr.html#csoundengine.Instr">[docs]</a><span class="k">class</span> <span class="nc">Instr</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Instr is a template used to schedule a concrete instrument</span>
<span class="sd">    at a Session or a Renderer. It must be registered to be used.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: the name of the instrument</span>
<span class="sd">        body: the body of the instr (the text **between** &#39;instr&#39; end &#39;endin&#39;)</span>
<span class="sd">        args: if given, a dictionary defining pfields and their defaults.</span>
<span class="sd">        init: code to be initialized at the instr0 level</span>
<span class="sd">        tabledef: An instrument can have an associated table to be able to pass</span>
<span class="sd">            dynamic parameters which are specific to this note (for example,</span>
<span class="sd">            an instrument could define a filter with a dynamic cutoff freq.)</span>
<span class="sd">            A tabledef is a dict of the form: {param_name: initial_value}.</span>
<span class="sd">            The order of appearence will correspond to the index in the table</span>
<span class="sd">        preschedCallback:</span>
<span class="sd">            a function f(synthid, args) -&gt; args, called before a note is</span>
<span class="sd">            scheduled with</span>
<span class="sd">            this instrument. Can be used to allocate a table or a dict and pass</span>
<span class="sd">            the resulting index to the instrument as parg</span>
<span class="sd">        freetable:</span>
<span class="sd">            if True, the associated table is freed when the note is finished</span>
<span class="sd">        doc: some documentation describing what this instr does</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: the name of this Instr</span>
<span class="sd">        body: the body of the instr (the text inside instr xxx/endin)</span>
<span class="sd">        args: a dict like `{&#39;ibus&#39;: 1, &#39;kfreq&#39;: 440}`, defining pfields and</span>
<span class="sd">            their default values. The mapping between pfield name and index</span>
<span class="sd">            is done by order, starting with p5.</span>
<span class="sd">        init: any global code needed</span>
<span class="sd">        tabledef: similar to args, but not using pfields but a table. In this</span>
<span class="sd">            case all variables are k-type and do not need the &quot;k&quot; prefix</span>
<span class="sd">        numchans: currently not used</span>
<span class="sd">        preschedCallback: a callback called whenever an instance of this Instr</span>
<span class="sd">            is scheduled</span>
<span class="sd">        freetable: if True, the Instr generates code to free the param table</span>
<span class="sd">        doc: some text documenting the use/purpose of this Instr</span>

<span class="sd">    Example</span>
<span class="sd">    =======</span>

<span class="sd">    .. code::</span>

<span class="sd">        s = Engine().getSession()</span>
<span class="sd">        Intr(&#39;sine&#39;, r&#39;&#39;&#39;</span>
<span class="sd">            kfreq = p5</span>
<span class="sd">            kamp = p6</span>
<span class="sd">            a0 = oscili:a(kamp, kfreq)</span>
<span class="sd">            outch 1, a0</span>
<span class="sd">        &#39;&#39;&#39;).register(s)</span>
<span class="sd">        synth = s.sched(&#39;sine&#39;, kfreq=440, kamp=0.1)</span>
<span class="sd">        synth.stop()</span>

<span class="sd">    An Instr can define default values for any of its p-fields:</span>

<span class="sd">    .. code::</span>

<span class="sd">        s = Engine().getSession()</span>
<span class="sd">        Intr(&#39;sine&#39;, args={&#39;kamp&#39;: 0.1, &#39;kfreq&#39;: 1000, body=r&#39;&#39;&#39;</span>
<span class="sd">            kamp = p5</span>
<span class="sd">            kfreq = p6</span>
<span class="sd">            a0 = oscili:a(kamp, kfreq)</span>
<span class="sd">            outch 1, a0</span>
<span class="sd">        &#39;&#39;&#39;).register(s)</span>
<span class="sd">        # We schedule an event of sine, kamp will take the default (0.1)</span>
<span class="sd">        synth = s.sched(&#39;sine&#39;, kfreq=440)</span>
<span class="sd">        synth.stop()</span>

<span class="sd">    An inline args declaration can set both pfield name and default value:</span>

<span class="sd">    .. code::</span>

<span class="sd">        s = Engine().getSession()</span>
<span class="sd">        Intr(&#39;sine&#39;, r&#39;&#39;&#39;</span>
<span class="sd">            |kamp=0.1, kfreq=1000|</span>
<span class="sd">            a0 = oscili:a(kamp, kfreq)</span>
<span class="sd">            outch 1, a0</span>
<span class="sd">        &#39;&#39;&#39;).register(s)</span>
<span class="sd">        synth = s.sched(&#39;sine&#39;, kfreq=440)</span>
<span class="sd">        synth.stop()</span>

<span class="sd">    The same can be achieved via an associated table:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        s = Engine().getSession()</span>
<span class="sd">        Intr(&#39;sine&#39;, r&#39;&#39;&#39;</span>
<span class="sd">            a0 = oscili:a(kamp, kfreq)</span>
<span class="sd">            outch 1, a0</span>
<span class="sd">        &#39;&#39;&#39;, tabledef=dict(amp=0.1, freq=1000</span>
<span class="sd">        ).register(s)</span>
<span class="sd">        synth = s.sched(&#39;sine&#39;, tabargs=dict(freq=440))</span>
<span class="sd">        synth.stop()</span>

<span class="sd">    This will create a table and fill it will the given/default values,</span>
<span class="sd">    and generate code to read from the table and free the table after</span>
<span class="sd">    the event is done. Call :meth:`~csoundengine.instr.Instr.dump` to see</span>
<span class="sd">    the generated code:</span>

<span class="sd">    .. code-block:: csound</span>

<span class="sd">        i_params = p4</span>
<span class="sd">        if ftexists(i_params) == 0 then</span>
<span class="sd">            initerror sprintf(&quot;params table (%d) does not exist&quot;, i_params)</span>
<span class="sd">        endif</span>
<span class="sd">        i__paramslen = ftlen(i_params)</span>
<span class="sd">        if i__paramslen &lt; {maxidx} then</span>
<span class="sd">            initerror sprintf(&quot;params table is too small (size: %d, needed: {maxidx})&quot;, i__paramslen)</span>
<span class="sd">        endif</span>
<span class="sd">        kamp tab 0, i_params</span>
<span class="sd">        kfreq tab 1, i_params</span>
<span class="sd">        a0 = oscili:a(kamp, kfreq)</span>
<span class="sd">        outch 1, a0</span>

<span class="sd">    An inline syntax exists also for tables:</span>

<span class="sd">    .. code::</span>

<span class="sd">        Intr(&#39;sine&#39;, r&#39;&#39;&#39;</span>
<span class="sd">            {amp=0.1, freq=1000}</span>
<span class="sd">            a0 = oscili:a(kamp, kfreq)</span>
<span class="sd">            outch 1, a0</span>
<span class="sd">        &#39;&#39;&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;_tableDefaultValues&#39;</span><span class="p">,</span> <span class="s1">&#39;_tableNameToIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;tabledef&#39;</span><span class="p">,</span>
    <span class="s1">&#39;numchans&#39;</span><span class="p">,</span> <span class="s1">&#39;mustFreeTable&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_numpargs&#39;</span><span class="p">,</span> <span class="s1">&#39;_recproc&#39;</span><span class="p">,</span> <span class="s1">&#39;_check&#39;</span><span class="p">,</span> <span class="s1">&#39;_preschedCallback&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pargsIndexToName&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pargsNameToIndex&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pargsDefaultValues&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">body</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">init</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">tabledef</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">numchans</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">preschedCallback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">freetable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">doc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errmsg</span> <span class="o">:=</span> <span class="n">_checkInstr</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CsoundError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tableDefaultValues</span><span class="p">:</span> <span class="n">Opt</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tableNameToIndex</span><span class="p">:</span> <span class="n">Opt</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">delimiters</span><span class="p">,</span> <span class="n">inline_args</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">_parse_inline_args</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">delimiters</span> <span class="o">==</span> <span class="s1">&#39;||&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">args</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">inline_args</span>
        <span class="k">elif</span> <span class="n">delimiters</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">tabledef</span>
            <span class="n">tabledef</span> <span class="o">=</span> <span class="n">inline_args</span>

        <span class="k">if</span> <span class="n">tabledef</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tableNameToIndex</span> <span class="o">=</span> <span class="p">{</span><span class="n">paramname</span><span class="p">:</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">paramname</span> <span class="ow">in</span>
                                      <span class="nb">enumerate</span><span class="p">(</span><span class="n">tabledef</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
            <span class="n">defaultvals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tabledef</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">minsize</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;associated_table_min_size&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">defaultvals</span><span class="p">)</span><span class="o">&lt;</span><span class="n">minsize</span><span class="p">:</span>
                <span class="n">defaultvals</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">minsize</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">defaultvals</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tableDefaultValues</span> <span class="o">=</span> <span class="n">defaultvals</span>
            <span class="n">tabcode</span> <span class="o">=</span> <span class="n">_tabledefGenerateCode</span><span class="p">(</span><span class="n">tabledef</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">textlib</span><span class="o">.</span><span class="n">joinPreservingIndentation</span><span class="p">((</span><span class="n">tabcode</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freetable</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">pfields</span> <span class="o">=</span> <span class="n">_pfieldsMergeDeclaration</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">startidx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">pargsIndexToName</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pfields</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">pargsDefaultValues</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">default</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pfields</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">_updatePfieldsCode</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">pargsIndexToName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">csoundlib</span><span class="o">.</span><span class="n">instrParseBody</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">pargsIndexToName</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">pfieldsIndexToName</span>
            <span class="n">pargsDefaultValues</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">pfieldsDefaults</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tabledef</span> <span class="o">=</span> <span class="n">tabledef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">init</span> <span class="k">if</span> <span class="n">init</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numchans</span> <span class="o">=</span> <span class="n">numchans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numpargs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recproc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;check_pargs&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preschedCallback</span> <span class="o">=</span> <span class="n">preschedCallback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pargsIndexToName</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">pargsIndexToName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pargsNameToIndex</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">pargsIndexToName</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pargsDefaultValues</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">pargsDefaultValues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mustFreeTable</span> <span class="o">=</span> <span class="n">freetable</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pargsRepr</span><span class="p">():</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabledef</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tabargs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tabledef</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Instr(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="nf">_pargsRepr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">pargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pargsIndexToName</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pargsDefaultValues</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">pname</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pargsDefaultValues</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                             <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pname</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pargs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pname</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pargs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Instr(name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">]</span>
        <span class="n">pargsStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pargsRepr</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pargsStr</span><span class="p">:</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pargsStr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">:</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&gt; doc: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">:</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&gt; init&quot;</span><span class="p">)</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tableDefaultValues</span><span class="p">:</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&gt; table&quot;</span><span class="p">)</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tabledef</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&gt; body&quot;</span><span class="p">)</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Instr</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register this Instr with a Session. This is the</span>
<span class="sd">        same as session.registerInstr(csoundinstr)</span>

<span class="sd">        Args:</span>
<span class="sd">            session (str|Session): the name of the Session or the Session itself</span>

<span class="sd">        Returns:</span>
<span class="sd">            self. This enables a declaration like: ``instr = Instr(...).register(session)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">engine</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">session</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span> <span class="k">else</span> <span class="n">engine</span><span class="o">.</span><span class="n">getSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">registerInstr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">pargIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parg</span><span class="p">:</span> <span class="n">U</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function, returns the index corresponding to the given parg.</span>

<span class="sd">        Args:</span>
<span class="sd">            parg (int|str): the index or the name of the p-field. If the</span>
<span class="sd">                index is given (as int), it is returned as is</span>

<span class="sd">        Returns:</span>
<span class="sd">            the index of the parg</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">parg</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parg</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> \
            <span class="n">_pargIndex</span><span class="p">(</span><span class="n">parg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pargsNameToIndex</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pargsTranslate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Seq</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">kws</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">U</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given pargs as values and keyword arguments, generate a list of</span>
<span class="sd">        values which can be passed to sched, starting with p5</span>
<span class="sd">        (p4 is reserved)</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: parg values, starting with p5</span>
<span class="sd">            **kws: named pargs (a name can also be &#39;p8&#39; for example)</span>

<span class="sd">        Returns:</span>
<span class="sd">            a list of float values with 0 representing absent pargs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">firstp</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># 4=p5</span>
        <span class="n">n2i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pargsNameToIndex</span>
        <span class="n">maxkwindex</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n2i</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">maxpargs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxkwindex</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pargs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">maxpargs</span><span class="o">-</span><span class="n">firstp</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pargsDefaultValues</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pargsDefaultValues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">pargs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">firstp</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">pargs</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">pargs</span><span class="p">)]</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">if</span> <span class="n">kws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">pname</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">_pargIndex</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">n2i</span><span class="p">)</span>
                <span class="n">pargs</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">pargs</span>

    <span class="k">def</span> <span class="nf">asOrc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrid</span><span class="p">,</span> <span class="n">sr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ksmps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nchnls</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
              <span class="n">a4</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a csound orchestra with only this instrument defined</span>

<span class="sd">        Args:</span>
<span class="sd">            instrid: the id (instr number of name) used for this instrument</span>
<span class="sd">            sr: samplerate</span>
<span class="sd">            ksmps: ksmps</span>
<span class="sd">            nchnls: number of channels</span>
<span class="sd">            a4: freq of A4</span>

<span class="sd">        Returns:</span>
<span class="sd">            The generated csound orchestra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">sr</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;rec.sr&#39;</span><span class="p">]</span>
        <span class="n">ksmps</span> <span class="o">=</span> <span class="n">ksmps</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ksmps&#39;</span><span class="p">]</span>
        <span class="n">a4</span> <span class="o">=</span> <span class="n">a4</span> <span class="k">if</span> <span class="n">a4</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;A4&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">initstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span>
        <span class="n">orc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        sr = </span><span class="si">{</span><span class="n">sr</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        ksmps = </span><span class="si">{</span><span class="n">ksmps</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        nchnls = </span><span class="si">{</span><span class="n">nchnls</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        0dbfs = 1.0</span>
<span class="s2">        A4 = </span><span class="si">{</span><span class="n">a4</span><span class="si">}</span><span class="s2"></span>

<span class="s2">        </span><span class="si">{</span><span class="n">initstr</span><span class="si">}</span><span class="s2"></span>

<span class="s2">        instr </span><span class="si">{</span><span class="n">instrid</span><span class="si">}</span><span class="s2"></span>

<span class="s2">        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2"></span>

<span class="s2">        endin</span>

<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">orc</span>

    <span class="k">def</span> <span class="nf">_numargs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numpargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_numpargs</span> <span class="o">=</span> <span class="n">csoundlib</span><span class="o">.</span><span class="n">instrParseBody</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">numPfields</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numpargs</span>

    <span class="k">def</span> <span class="nf">_checkArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">lenargs</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">numargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numargs</span><span class="p">()</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">numargs</span> <span class="o">==</span> <span class="n">lenargs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;expected </span><span class="si">{</span><span class="n">numargs</span><span class="si">}</span><span class="s2"> args, got </span><span class="si">{</span><span class="n">lenargs</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ok</span>

    <span class="k">def</span> <span class="nf">rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">sr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ksmps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">samplefmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nchnls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">a4</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record this Instr for a given duration</span>

<span class="sd">        Args:</span>
<span class="sd">            dur: the duration of the recording</span>
<span class="sd">            outfile: if given, the path to the generated soundfile.</span>
<span class="sd">                If not given, a temporary file will be generated.</span>
<span class="sd">            args: the seq. of pargs passed to the instrument (if any),</span>
<span class="sd">                beginning with p4</span>
<span class="sd">            sr: the sample rate -&gt; config[&#39;rec.sr&#39;]</span>
<span class="sd">            ksmps: the number of samples per cycle -&gt; config[&#39;rec.ksmps&#39;]</span>
<span class="sd">            samplefmt: one of 16, 24, 32, or &#39;float&#39; -&gt; config[&#39;rec.sample_format&#39;]</span>
<span class="sd">            nchnls: the number of channels of the generated soundfile.</span>
<span class="sd">            block: if True, the function blocks until done, otherwise rendering</span>
<span class="sd">                is asynchronous</span>
<span class="sd">            a4: the frequency of A4 (see config[&#39;A4&#39;]</span>

<span class="sd">        See Also:</span>
<span class="sd">            :meth:`~Instr.recEvents`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dur</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recEvents</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="n">event</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
                              <span class="n">ksmps</span><span class="o">=</span><span class="n">ksmps</span><span class="p">,</span> <span class="n">samplefmt</span><span class="o">=</span><span class="n">samplefmt</span><span class="p">,</span> <span class="n">nchnls</span><span class="o">=</span><span class="n">nchnls</span><span class="p">,</span>
                              <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">sr</span><span class="o">=</span><span class="mi">44100</span><span class="p">,</span> <span class="n">ksmps</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">samplefmt</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">nchnls</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                  <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="kc">None</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record the given events with this instrument.</span>

<span class="sd">        Args:</span>
<span class="sd">            events: a seq. of events, where each event is the list of pargs</span>
<span class="sd">                passed to the instrument, as [delay, dur, p4, p5, ...]</span>
<span class="sd">                (p1 is omitted)</span>
<span class="sd">            outfile: if given, the path to the generated soundfile. If not</span>
<span class="sd">                given, a temporary file will be generated.</span>
<span class="sd">            sr: the sample rate -&gt; config[&#39;rec.sr&#39;]</span>
<span class="sd">            ksmps: the number of samples per cycle -&gt; config[&#39;rec.ksmps&#39;]</span>
<span class="sd">            samplefmt: one of 16, 24, 32, or &#39;float&#39; -&gt; config[&#39;rec.sample_format&#39;]</span>
<span class="sd">            nchnls: the number of channels of the generated soundfile.</span>
<span class="sd">            a4: the frequency of A4 (see config[&#39;A4&#39;]</span>
<span class="sd">            block: if True, the function blocks until done, otherwise rendering</span>
<span class="sd">                is asynchronous</span>

<span class="sd">        Returns:</span>
<span class="sd">            the generated soundfile (if outfile is not given, a temp file</span>
<span class="sd">            is created)</span>

<span class="sd">        See Also:</span>
<span class="sd">            :meth:`~Instr.rec`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a4</span> <span class="o">=</span> <span class="n">a4</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;A4&#39;</span><span class="p">]</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">sr</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;rec.sr&#39;</span><span class="p">]</span>
        <span class="n">ksmps</span> <span class="o">=</span> <span class="n">ksmps</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;rec.ksmps&#39;</span><span class="p">]</span>
        <span class="n">samplefmt</span> <span class="o">=</span> <span class="n">samplefmt</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;rec.sample_format&#39;</span><span class="p">]</span>
        <span class="n">initstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">a4</span> <span class="o">=</span> <span class="n">a4</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;A4&#39;</span><span class="p">]</span>
        <span class="n">outfile</span><span class="p">,</span> <span class="n">popen</span> <span class="o">=</span> <span class="n">csoundlib</span><span class="o">.</span><span class="n">recInstr</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
                                            <span class="n">init</span><span class="o">=</span><span class="n">initstr</span><span class="p">,</span>
                                            <span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span>
                                            <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">,</span>
                                            <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
                                            <span class="n">ksmps</span><span class="o">=</span><span class="n">ksmps</span><span class="p">,</span>
                                            <span class="n">samplefmt</span><span class="o">=</span><span class="n">samplefmt</span><span class="p">,</span>
                                            <span class="n">nchnls</span><span class="o">=</span><span class="n">nchnls</span><span class="p">,</span>
                                            <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">popen</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">outfile</span>

    <span class="k">def</span> <span class="nf">hasExchangeTable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if this instrument defines an exchange table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tableDefaultValues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tableDefaultValues</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>

    <span class="k">def</span> <span class="nf">overrideTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides default values in the exchange table</span>
<span class="sd">        Returns the initial values</span>

<span class="sd">        Args:</span>
<span class="sd">            d: if given, a dictionary of the form {&#39;argname&#39;: value}.</span>
<span class="sd">                Alternatively key/value pairs can be passed as keywords</span>
<span class="sd">            **kws: each key must match a named parameter as defined in</span>
<span class="sd">                the tabledef</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of floats holding the new initial values of the</span>
<span class="sd">            exchange table</span>

<span class="sd">        Example:</span>
<span class="sd">            instr.overrideTable(param1=value1, param2=value2)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tableDefaultValues</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This instrument has no associated table&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tableNameToIndex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This instrument has no table mapping, so&quot;</span>
                             <span class="s2">&quot;named parameters can&#39;t be used&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kws</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tableDefaultValues</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tableDefaultValues</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tableNameToIndex</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">kws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tableNameToIndex</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">out</span></div>



<span class="k">def</span> <span class="nf">_checkInstr</span><span class="p">(</span><span class="n">instr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an error message if the instrument is not well defined</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="k">if</span> <span class="n">line</span><span class="p">]</span>
    <span class="n">errmsg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;instr&quot;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;endin&quot;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;instr should be the body of the instrument,&quot;</span>
                  <span class="s2">&quot; without &#39;instr&#39; and &#39;endin&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">errmsg</span>


<span class="k">def</span> <span class="nf">_parse_inline_args</span><span class="p">(</span><span class="n">body</span><span class="p">:</span> <span class="n">U</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Opt</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse an instr body with a possible args declaration (see below).</span>

<span class="sd">    Args:</span>
<span class="sd">        body: the body of the instrument as a string or as a list of lines</span>

<span class="sd">    Returns:</span>
<span class="sd">        a tuple (delimiters, fields, body without fields declaration), with:</span>

<span class="sd">        * delimiters: the string &quot;||&quot; or &quot;{}&quot;, identifying the kind of inline declaration</span>
<span class="sd">        * fields: a dictionary mapping field name to default value</span>
<span class="sd">        * body without declaration: the body of the instrument, as a string, without</span>
<span class="sd">            the line declaring fields.</span>

<span class="sd">        In the case that the body has no inline declaration delimiters will be an empty</span>
<span class="sd">        string</span>

<span class="sd">    .. note::</span>
<span class="sd">        this is not supported csound syntax, we added this ad-hoc syntax</span>
<span class="sd">        extension to more easily declare named pfields. In the future a possible</span>
<span class="sd">        solution might be an opcode:</span>

<span class="sd">            kamp, kfreq, kcutoff pfields 4, 0.1, 440, 2000</span>

<span class="sd">    Example</span>
<span class="sd">    =======</span>

<span class="sd">        &gt;&gt;&gt; body = &#39;&#39;&#39;</span>
<span class="sd">        ... |ichan, kamp=0.1, kfreq=440|</span>
<span class="sd">        ... a0 oscili kamp, kfreq</span>
<span class="sd">        ... outch ichan, a0</span>
<span class="sd">        ... &#39;&#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; delimiters, args, body2 = _parse_inline_args(body)</span>
<span class="sd">        &gt;&gt;&gt; delimiters</span>
<span class="sd">        &#39;||&#39;</span>
<span class="sd">        &gt;&gt;&gt; args</span>
<span class="sd">        {&#39;ichan&#39;: 0, &#39;kamp&#39;: 0.1, &#39;kfreq&#39;: 440}</span>
<span class="sd">        &gt;&gt;&gt; print(body2)</span>
<span class="sd">        a0 oscili kamp, kfreq</span>
<span class="sd">        outch 1, a0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">body</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">body</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">delimiters</span><span class="p">,</span> <span class="n">linenum</span> <span class="o">=</span> <span class="n">_detect_inline_args</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">delimiters</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">body</span>
    <span class="n">pfields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">line2</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">linenum</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">line2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
            <span class="n">varname</span><span class="p">,</span> <span class="n">defaultval</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
            <span class="n">pfields</span><span class="p">[</span><span class="n">varname</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">defaultval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pfields</span><span class="p">[</span><span class="n">part</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">body2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">linenum</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">delimiters</span><span class="p">,</span> <span class="n">pfields</span><span class="p">,</span> <span class="n">body2</span>

<span class="k">def</span> <span class="nf">_tabledefGenerateCode</span><span class="p">(</span><span class="n">tabledef</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxidx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tabledef</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
    <span class="n">_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ; --- start generated table code</span>
<span class="s2">    i_params = p4</span>
<span class="s2">    if ftexists(i_params) == 0 then</span>
<span class="s2">        initerror sprintf(&quot;params table (%d) does not exist&quot;, i_params)</span>
<span class="s2">    endif</span>
<span class="s2">    i__paramslen = ftlen(i_params)</span>
<span class="s2">    if i__paramslen &lt; </span><span class="si">{</span><span class="n">maxidx</span><span class="si">}</span><span class="s2"> then</span>
<span class="s2">        initerror sprintf(&quot;params table is too small (size: %d, needed: </span><span class="si">{</span><span class="n">maxidx</span><span class="si">}</span><span class="s2">)&quot;, i__paramslen)</span>
<span class="s2">    endif</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tabledef</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;k</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> tab </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">, i_params&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;; --- end generated table code</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">textlib</span><span class="o">.</span><span class="n">joinPreservingIndentation</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_pfieldsMergeDeclaration</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">body</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">startidx</span><span class="o">=</span><span class="mi">4</span>
                             <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dictionary declaring pfields and their defaults,</span>
<span class="sd">    merge these with the pfields declared in the body, returning</span>
<span class="sd">    a dictionary of the form {pindex: (name, default value)}</span>

<span class="sd">    Args:</span>
<span class="sd">        args: a dict mapping pfield name to a default value. The index</span>
<span class="sd">            is assigned in the order of appearence, starting with `startidx`</span>
<span class="sd">        body: the body of the instrument (the part between instr/endin)</span>
<span class="sd">        startidx: the start index for the pfields declared in `args`</span>

<span class="sd">    Returns:</span>
<span class="sd">        a dict mapping pfield index to a tuple (name, default value). pfields</span>
<span class="sd">        without default receive a fallback value of 0.</span>

<span class="sd">    Example</span>
<span class="sd">    =======</span>

<span class="sd">        &gt;&gt;&gt; body = &#39;&#39;&#39;</span>
<span class="sd">        ... ichan = p5</span>
<span class="sd">        ... ifade, icutoff passign 6</span>
<span class="sd">        ... &#39;&#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; _pfieldsMergeDeclaration(dict(kfreq=440, ichan=2), body)</span>
<span class="sd">        {4: (&#39;kfreq&#39;, 440),</span>
<span class="sd">         5: (&#39;ichan&#39;, 2),</span>
<span class="sd">         6: (&#39;ifade&#39;, 0),</span>
<span class="sd">         7: (&#39;icutoff&#39;, 0)}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: take pset into consideration for defaults</span>
    <span class="n">parsedbody</span> <span class="o">=</span> <span class="n">csoundlib</span><span class="o">.</span><span class="n">instrParseBody</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">body_i2n</span> <span class="o">=</span> <span class="n">parsedbody</span><span class="o">.</span><span class="n">pfieldsIndexToName</span>
    <span class="n">args_i2n</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">n</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="n">startidx</span><span class="p">)}</span>
    <span class="n">allindexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">body_i2n</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">allindexes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args_i2n</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">pfields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">allindexes</span><span class="p">:</span>
        <span class="n">body_n</span> <span class="o">=</span> <span class="n">body_i2n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">args_n</span> <span class="o">=</span> <span class="n">args_i2n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">body_n</span> <span class="ow">and</span> <span class="n">args_n</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pfield conflict, p</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> is defined both&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;in the body of the instrument (name: </span><span class="si">{</span><span class="n">body_n</span><span class="si">}</span><span class="s2">)&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;and as an argument (name: </span><span class="si">{</span><span class="n">args_n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">body_n</span><span class="p">:</span>
            <span class="n">pfields</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">body_n</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pfields</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">args_n</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="n">args_n</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pfields</span>


<span class="k">def</span> <span class="nf">_updatePfieldsCode</span><span class="p">(</span><span class="n">body</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idx2name</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">parsedCode</span> <span class="o">=</span> <span class="n">csoundlib</span><span class="o">.</span><span class="n">instrParseBody</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">newPfieldCode</span> <span class="o">=</span> <span class="n">_pfieldsGenerateCode</span><span class="p">(</span><span class="n">idx2name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">textlib</span><span class="o">.</span><span class="n">joinPreservingIndentation</span><span class="p">((</span><span class="n">newPfieldCode</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">parsedCode</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
    <span class="c1"># return &quot;\n&quot;.join((newPfieldCode, &quot;&quot;, parsedCode.body))</span>


<span class="k">def</span> <span class="nf">_pargIndex</span><span class="p">(</span><span class="n">parg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pargMapping</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">pargMapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># try with a k-</span>
        <span class="k">if</span> <span class="n">parg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">pargMapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;k&#39;</span> <span class="o">+</span> <span class="n">parg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">idx</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pargMapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;p&quot;</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parg &#39;</span><span class="si">{</span><span class="n">parg</span><span class="si">}</span><span class="s2">&#39; not found. &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;Possible pargs: </span><span class="si">{</span><span class="n">keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">idx</span>

<span class="k">def</span> <span class="nf">_detect_inline_args</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Opt</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of lines of an instrument&#39;s body, detect</span>
<span class="sd">    if the instrument has inline args defined, and which kind</span>

<span class="sd">    Inline args are defined in two ways:</span>

<span class="sd">    * ``|ichan, kamp=0.5, kfreq=1000|``</span>
<span class="sd">    * ``{ichan, kamp=0.5, kfreq=1000}``</span>

<span class="sd">    Args:</span>
<span class="sd">        lines: the body of the instrument split in lines</span>

<span class="sd">    Returns:</span>
<span class="sd">        a tuple (kind of delimiters, line number), where kind of</span>
<span class="sd">        delimiters will be either &quot;||&quot; or &quot;{}&quot;. If no inline args are found</span>
<span class="sd">        the tuple (&quot;&quot;, 0) is returned</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;|&quot;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;{&quot;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span>
        <span class="k">break</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_pfieldsGenerateCode</span><span class="p">(</span><span class="n">pfields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        pfields: a dict mapping p-index to name</span>

<span class="sd">    Returns:</span>
<span class="sd">        the generated code</span>

<span class="sd">    Example</span>
<span class="sd">    =======</span>

<span class="sd">        &gt;&gt;&gt; print(_pfieldsGenerateCode({4: &#39;ichan&#39;, 5:&#39;kfreq&#39;}))</span>
<span class="sd">        ichan = p4</span>
<span class="sd">        kfreq = p5</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pfields</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">pairs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> = p</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Eduardo Moguillansky.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>